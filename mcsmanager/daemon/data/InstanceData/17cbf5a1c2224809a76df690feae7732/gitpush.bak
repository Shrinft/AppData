#!/bin/bash

# SFTP配置
SFTP_HOST="156.246.90.110"
SFTP_PORT="11520"
SFTP_USER="21369"
SFTP_PASS="xu34LDICRy6!"
LOCAL_DIR="/workspace/AppData/MinecraftServer"
ZIP_FILE="world.zip"
LOCAL_ZIP_PATH="$LOCAL_DIR/$ZIP_FILE"

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 显示菜单
show_menu() {
    clear
    echo -e "${GREEN}=== Minecraft世界文件传输工具 ===${NC}"
    echo -e "${BLUE}本地目录: $LOCAL_DIR${NC}"
    echo -e "${BLUE}SFTP服务器: $SFTP_USER@$SFTP_HOST:$SFTP_PORT${NC}"
    echo ""
    echo -e "${YELLOW}请选择操作:${NC}"
    echo -e "  ${GREEN}[D]${NC}ownload - 从服务器下载世界文件"
    echo -e "  ${GREEN}[U]${NC}pload   - 上传世界文件到服务器"
    echo -e "  ${GREEN}[C]${NC}ancel   - 取消"
    echo ""
    echo -n "请选择 [D/U/C]: "
}

# 检查并安装必要工具
install_tools() {
    echo -e "${YELLOW}检查所需工具...${NC}"
    
    # 检查sshpass
    if ! command -v sshpass &> /dev/null; then
        echo -e "${YELLOW}安装sshpass...${NC}"
        apt-get update > /dev/null 2>&1
        apt-get install -y sshpass > /dev/null 2>&1
        if [ $? -ne 0 ]; then
            echo -e "${RED}安装sshpass失败${NC}"
            return 1
        fi
        echo -e "${GREEN}sshpass安装完成${NC}"
    fi
    
    # 检查zip/unzip
    if ! command -v zip &> /dev/null || ! command -v unzip &> /dev/null; then
        echo -e "${YELLOW}安装zip/unzip...${NC}"
        apt-get update > /dev/null 2>&1
        apt-get install -y zip unzip > /dev/null 2>&1
        if [ $? -ne 0 ]; then
            echo -e "${RED}安装zip/unzip失败${NC}"
            return 1
        fi
        echo -e "${GREEN}zip/unzip安装完成${NC}"
    fi
    
    return 0
}

# 接受主机密钥
accept_host_key() {
    echo -e "${YELLOW}添加SFTP主机密钥...${NC}"
    
    # 先清理旧密钥
    ssh-keygen -R "[$SFTP_HOST]:$SFTP_PORT" > /dev/null 2>&1
    ssh-keygen -R "$SFTP_HOST:$SFTP_PORT" > /dev/null 2>&1
    
    # 添加新密钥（重试3次）
    for i in {1..3}; do
        ssh-keyscan -p "$SFTP_PORT" -H "$SFTP_HOST" >> ~/.ssh/known_hosts 2>/dev/null
        if [ $? -eq 0 ]; then
            echo -e "${GREEN}主机密钥添加成功${NC}"
            return 0
        fi
        sleep 1
    done
    
    echo -e "${YELLOW}警告: 无法自动添加主机密钥，将使用StrictHostKeyChecking=no${NC}"
    return 1
}

# 下载世界文件
download_world() {
    echo -e "${GREEN}开始下载世界文件...${NC}"
    
    # 确保目录存在
    mkdir -p "$LOCAL_DIR"
    
    # 清理旧文件
    rm -f "$LOCAL_ZIP_PATH"
    
    # 下载文件 - 直接在当前目录下载world.zip到本地路径
    echo -e "${YELLOW}连接SFTP服务器...${NC}"
    
    sshpass -p "$SFTP_PASS" sftp -oPort="$SFTP_PORT" -oStrictHostKeyChecking=no -oBatchMode=no "$SFTP_USER@$SFTP_HOST" <<EOF
get "world.zip" "$LOCAL_ZIP_PATH"
bye
EOF
    
    # 检查是否下载成功
    if [ -f "$LOCAL_ZIP_PATH" ]; then
        echo -e "${GREEN}文件下载成功 (大小: $(du -h "$LOCAL_ZIP_PATH" | cut -f1))${NC}"
        
        # 备份旧的世界文件夹
        if [ -d "$LOCAL_DIR/world" ]; then
            echo -e "${YELLOW}备份旧的世界文件...${NC}"
            backup_dir="${LOCAL_DIR}_backup_$(date +%Y%m%d_%H%M%S)"
            cp -r "$LOCAL_DIR/world" "$backup_dir" 2>/dev/null
            echo -e "${GREEN}已备份到: $backup_dir${NC}"
        fi
        
        # 解压文件
        echo -e "${YELLOW}正在解压文件...${NC}"
        cd "$LOCAL_DIR"
        
        # 先删除旧的世界文件夹
        rm -rf "$LOCAL_DIR/world" 2>/dev/null
        
        # 解压
        unzip -q -o "$ZIP_FILE"
        
        if [ -d "$LOCAL_DIR/world" ]; then
            echo -e "${GREEN}世界文件解压成功${NC}"
            
            # 删除zip文件
            rm -f "$ZIP_FILE"
            echo -e "${GREEN}已删除临时文件${NC}"
            
            # 显示结果
            echo -e "${YELLOW}世界文件夹内容:${NC}"
            ls -la "$LOCAL_DIR/world/" | head -5
            
            # 统计文件数量
            file_count=$(find "$LOCAL_DIR/world" -type f | wc -l)
            echo -e "${GREEN}共 $file_count 个文件${NC}"
        else
            echo -e "${RED}解压失败，世界文件夹未创建${NC}"
            return 1
        fi
    else
        echo -e "${RED}下载失败！请检查:${NC}"
        echo "1. SFTP服务器是否可访问"
        echo "2. 用户名密码是否正确"
        echo "3. 服务器上是否存在 world.zip 文件"
        echo "4. 注意：服务器上的文件应该位于用户默认目录下，不是根目录"
        
        # 尝试列出服务器上的文件
        echo -e "${YELLOW}尝试列出服务器上的文件...${NC}"
        sshpass -p "$SFTP_PASS" sftp -oPort="$SFTP_PORT" -oStrictHostKeyChecking=no -oBatchMode=no "$SFTP_USER@$SFTP_HOST" <<EOF
ls -la
bye
EOF
        
        return 1
    fi
}

# 上传世界文件
upload_world() {
    echo -e "${GREEN}开始上传世界文件...${NC}"
    
    # 检查本地是否有压缩文件，如果没有则先压缩
    if [ ! -f "$LOCAL_ZIP_PATH" ]; then
        echo -e "${YELLOW}本地未找到 $ZIP_FILE，正在检查世界文件夹...${NC}"
        
        # 检查世界文件夹是否存在
        if [ ! -d "$LOCAL_DIR/world" ]; then
            echo -e "${RED}错误: 世界文件夹不存在${NC}"
            echo "路径: $LOCAL_DIR/world"
            ls -la "$LOCAL_DIR/" 2>/dev/null || echo "目录不存在"
            return 1
        fi
        
        # 检查世界文件夹是否为空
        if [ -z "$(ls -A "$LOCAL_DIR/world" 2>/dev/null)" ]; then
            echo -e "${RED}错误: 世界文件夹为空${NC}"
            return 1
        fi
        
        # 压缩世界文件夹
        echo -e "${YELLOW}正在压缩世界文件夹...${NC}"
        cd "$LOCAL_DIR"
        
        # 删除可能存在的旧zip文件
        rm -f "$ZIP_FILE"
        
        # 压缩（显示进度）
        echo -e "${YELLOW}正在压缩，请稍候...${NC}"
        zip -r -q "$ZIP_FILE" "world"
        
        if [ ! -f "$ZIP_FILE" ]; then
            echo -e "${RED}压缩失败${NC}"
            return 1
        fi
        
        zip_size=$(du -h "$ZIP_FILE" | cut -f1)
        echo -e "${GREEN}压缩完成 (大小: $zip_size)${NC}"
    else
        echo -e "${YELLOW}使用现有的压缩文件: $LOCAL_ZIP_PATH${NC}"
        zip_size=$(du -h "$LOCAL_ZIP_PATH" | cut -f1)
        echo -e "${GREEN}文件大小: $zip_size${NC}"
    fi
    
    # 上传文件 - 直接上传当前目录的world.zip
    echo -e "${YELLOW}连接SFTP服务器...${NC}"
    
    sshpass -p "$SFTP_PASS" sftp -oPort="$SFTP_PORT" -oStrictHostKeyChecking=no -oBatchMode=no "$SFTP_USER@$SFTP_HOST" <<EOF
put "$LOCAL_ZIP_PATH" "world.zip"
bye
EOF
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}世界文件上传成功${NC}"
        
        # 询问是否删除本地zip文件
        echo -n -e "${YELLOW}是否删除本地临时文件 $ZIP_FILE？[y/N]: ${NC}"
        read -n 1 delete_choice
        echo ""
        
        if [[ "$delete_choice" =~ ^[Yy]$ ]]; then
            rm -f "$LOCAL_ZIP_PATH"
            echo -e "${GREEN}已删除本地临时文件${NC}"
        else
            echo -e "${YELLOW}保留本地临时文件${NC}"
        fi
    else
        echo -e "${RED}上传失败${NC}"
        return 1
    fi
}

# 主函数
main() {
    # 检查是否以root运行
    if [ "$EUID" -ne 0 ]; then 
        echo -e "${YELLOW}警告: 建议使用root权限运行${NC}"
    fi
    
    # 安装必要工具
    install_tools
    if [ $? -ne 0 ]; then
        echo -e "${RED}工具安装失败，请手动安装:${NC}"
        echo "apt-get install -y sshpass zip unzip"
        exit 1
    fi
    
    # 接受主机密钥
    accept_host_key
    
    # 显示菜单并获取用户选择
    while true; do
        show_menu
        
        # 读取用户输入
        read -n 1 choice
        choice=$(echo "$choice" | tr '[:upper:]' '[:lower:]')
        echo ""  # 换行
        
        case "$choice" in
            d)
                echo -e "${GREEN}你选择了: 下载世界文件${NC}"
                echo ""
                download_world
                
                if [ $? -eq 0 ]; then
                    echo -e "${GREEN}✓ 下载操作完成${NC}"
                else
                    echo -e "${RED}✗ 下载操作失败${NC}"
                fi
                
                echo ""
                read -n 1 -p "按任意键返回主菜单..."
                ;;
                
            u)
                echo -e "${GREEN}你选择了: 上传世界文件${NC}"
                echo ""
                upload_world
                
                if [ $? -eq 0 ]; then
                    echo -e "${GREEN}✓ 上传操作完成${NC}"
                else
                    echo -e "${RED}✗ 上传操作失败${NC}"
                fi
                
                echo ""
                read -n 1 -p "按任意键返回主菜单..."
                ;;
                
            c)
                echo -e "${YELLOW}取消操作，退出程序${NC}"
                exit 0
                ;;
                
            *)
                echo -e "${RED}无效选择，请重新输入${NC}"
                sleep 1
                continue
                ;;
        esac
    done
}

# 捕获Ctrl+C
trap 'echo -e "\n${YELLOW}程序被用户中断${NC}"; exit 1' INT

# 执行主函数
main